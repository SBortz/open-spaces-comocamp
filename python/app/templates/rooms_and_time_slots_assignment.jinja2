<!DOCTYPE html>
<html lang="en">
<head>
    <link rel="stylesheet" href="/css/styles.css">

    <meta charset="UTF-8">
    <title>Room and Time Slot Matrix</title>
    <style>
        table {
            width: 100%;
            border-collapse: collapse;
        }

        th, td {
            border: 1px solid black;
            text-align: center;
            padding: 8px;
        }

        th {
            background-color: #f2f2f2;
        }
    </style>

    <script>
      function assignTopic(room, startTime, endTime) {
        // Construct an ID to find the correct <select> element
        var selectId = `assign_${room}_${startTime}_${endTime}`;
        var selectElement = document.getElementById(selectId);
        var topic = selectElement.value; // Retrieves the selected option value

        // Assuming conferenceId and conference are available globals or derived similarly
        var conferenceId = document.getElementById('conference_id').value;
        var conference = document.getElementById('conference').value;

        var payload = {
          conferenceId: conferenceId,
          room: room,
          conference: conference,
          topic: topic,
          startTime: startTime,
          endTime: endTime
        };
        console.log('Payload:', payload);
        // Send this payload to your server
        var url = "/assign_topic";

        fetch(url, {
          method: "POST",
          headers: {"Content-Type": "application/json"},
          body: JSON.stringify(payload),
        })
          .then(response => {
            if (response.redirected) {
              // Server has initiated a redirect
              window.location.href = response.url;
            } else if (!response.ok) {
              // Handle non-successful response
              throw new Error('Server responded with an error!');
            } else {
              // If you expect a non-redirect successful response, handle here
              console.log('Request successful');
            }
          })
          .catch(error => console.error('Error:', error));
      }
    </script>


</head>
<body>
{{ data }}
<h1>{{ data.conference }}</h1>


<input hidden type="text" id="conference_id" value="{{ data.conference_id }}">
<input hidden type="text" id="conference" value="{{ data.conference }}">
<h2>Room and Time Slot Matrix</h2>
<table>
    <thead>
    <tr>
        <th>Time Slots / Rooms</th>
        {% for room in data.rooms %}
            <th>{{ room }}</th>
        {% endfor %}
    </tr>
    </thead>
    <tbody>
    {% for time_slot in data.timeSlots %}
        <tr>
            <td>{{ time_slot }}</td>
            {% for room in data.rooms %}
                {# we check if there is a topic assigned for this cell #}
                {% for t, a in data.topicAssignments.items() %}
                    {{ t, a, room.room, time_slot.startTime, time_slot.endTime }}
                    {% if a.room == room.room and a.startTime == time_slot.startTime and a.endTime == time_slot.endTime %}
                        found
                        <td>{{ t }}</td>
                        {% set topic = a.topic %}
                        {{ a.topic }}
                    {% endif %}
                {% endfor %}

                {# If there are unassigned topics, show a dropdown to assign them #}

                {% for topic in data.unassignedTopics %}
                    <td>
                        <label for="assign_{{ room.room }}_{{ time_slot.startTime }}_{{ time_slot.endTime }}">Assign
                            Topic
                        </label>
                        <select
                                id="assign_{{ room.room }}_{{ time_slot.startTime }}_{{ time_slot.endTime }}">
                            <option value="Available">Available</option>
                            <option value="{{ topic }}">{{ topic }}</option>
                        </select>
                        <button onclick="assignTopic('{{ room.room }}', '{{ time_slot.startTime }}', '{{ time_slot.endTime }}')">
                            Assign
                        </button>
                    </td>
                {% endfor %}

            {% endfor %}
        </tr>
    {% endfor %}
    </tbody>
</table>
</body>
</html>